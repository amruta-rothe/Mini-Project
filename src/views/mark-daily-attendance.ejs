<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title><%= pageTitle %> - AttendanceMS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">
  <style>
    .student-card {
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }
    .student-card.present { border-color: #28a745; background-color: #f8fff9; }
    .student-card.absent { border-color: #dc3545; background-color: #fff8f8; }
    .student-card.late { border-color: #ffc107; background-color: #fffdf7; }
    .student-card.excused { border-color: #17a2b8; background-color: #f7fdff; }
    
    .status-btn {
      border-radius: 20px;
      padding: 8px 16px;
      border: 2px solid;
      background: white;
      transition: all 0.3s ease;
    }
    .status-btn.active {
      color: white !important;
    }
    .status-btn.present { border-color: #28a745; color: #28a745; }
    .status-btn.present.active { background-color: #28a745; }
    .status-btn.absent { border-color: #dc3545; color: #dc3545; }
    .status-btn.absent.active { background-color: #dc3545; }
    .status-btn.late { border-color: #ffc107; color: #ffc107; }
    .status-btn.late.active { background-color: #ffc107; }
    .status-btn.excused { border-color: #17a2b8; color: #17a2b8; }
    .status-btn.excused.active { background-color: #17a2b8; }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
    <div class="container-fluid">
      <a class="navbar-brand" href="/dashboard">
        <i class="fas fa-graduation-cap me-2"></i>AttendanceMS
      </a>
      <div class="navbar-nav ms-auto">
        <a class="nav-link" href="/daily-attendance">
          <i class="fas fa-arrow-left me-1"></i>Back to Daily Attendance
        </a>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h2><i class="fas fa-edit me-2 text-primary"></i>Mark Attendance</h2>
            <p class="text-muted mb-0">
              <strong><%= class.name %></strong>
              <% if (class.section) { %> - Section <%= class.section %><% } %>
              | <%= new Date(today).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %>
            </p>
          </div>
          <div>
            <button type="button" class="btn btn-success me-2" onclick="markAllPresent()">
              <i class="fas fa-check-double me-2"></i>Mark All Present
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="clearAll()">
              <i class="fas fa-eraser me-2"></i>Clear All
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Stats -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="card border-success">
          <div class="card-body text-center">
            <h4 class="text-success mb-1" id="presentCount">0</h4>
            <small>Present</small>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card border-danger">
          <div class="card-body text-center">
            <h4 class="text-danger mb-1" id="absentCount">0</h4>
            <small>Absent</small>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card border-warning">
          <div class="card-body text-center">
            <h4 class="text-warning mb-1" id="lateCount">0</h4>
            <small>Late</small>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card border-info">
          <div class="card-body text-center">
            <h4 class="text-info mb-1" id="excusedCount">0</h4>
            <small>Excused</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Attendance Form -->
    <form id="attendanceForm" method="POST" action="/class/<%= class.id %>/daily-attendance">
      <div class="row">
        <% students.forEach((student, index) => { %>
          <div class="col-lg-6 col-xl-4 mb-4">
            <div class="card student-card" id="student-<%= student.id %>" data-student-id="<%= student.id %>">
              <div class="card-body">
                <!-- Student Info -->
                <div class="d-flex align-items-center mb-3">
                  <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" 
                       style="width: 50px; height: 50px; font-weight: bold;">
                    <%= student.roll_no || (index + 1) %>
                  </div>
                  <div class="flex-grow-1">
                    <h6 class="mb-1"><%= student.name %></h6>
                    <% if (student.parent_name) { %>
                      <small class="text-muted">
                        <i class="fas fa-user me-1"></i><%= student.parent_name %>
                      </small><br>
                    <% } %>
                    <% if (student.parent_email) { %>
                      <small class="text-muted">
                        <i class="fas fa-envelope me-1"></i><%= student.parent_email %>
                      </small>
                    <% } %>
                  </div>
                </div>

                <!-- Status Buttons -->
                <div class="btn-group w-100 mb-3" role="group">
                  <button type="button" class="btn status-btn present <%= student.status === 'present' ? 'active' : '' %>" 
                          onclick="setStatus(<%= student.id %>, 'present')">
                    <i class="fas fa-check"></i>
                  </button>
                  <button type="button" class="btn status-btn absent <%= student.status === 'absent' ? 'active' : '' %>" 
                          onclick="setStatus(<%= student.id %>, 'absent')">
                    <i class="fas fa-times"></i>
                  </button>
                  <button type="button" class="btn status-btn late <%= student.status === 'late' ? 'active' : '' %>" 
                          onclick="setStatus(<%= student.id %>, 'late')">
                    <i class="fas fa-clock"></i>
                  </button>
                  <button type="button" class="btn status-btn excused <%= student.status === 'excused' ? 'active' : '' %>" 
                          onclick="setStatus(<%= student.id %>, 'excused')">
                    <i class="fas fa-user-check"></i>
                  </button>
                </div>

                <!-- Note Input -->
                <div class="mb-2">
                  <input type="text" class="form-control form-control-sm" 
                         name="notes[<%= student.id %>]" 
                         placeholder="Add note (optional)"
                         value="<%= student.note || '' %>">
                </div>

                <!-- Hidden input for attendance status -->
                <input type="hidden" name="attendance[<%= student.id %>]" 
                       value="<%= student.status || '' %>" 
                       id="status-<%= student.id %>">
              </div>
            </div>
          </div>
        <% }) %>
      </div>

      <!-- Submit Button -->
      <div class="row mt-4">
        <div class="col-12 text-center">
          <button type="submit" class="btn btn-primary btn-lg px-5">
            <i class="fas fa-save me-2"></i>Save Attendance
          </button>
        </div>
      </div>
    </form>

    <% if (students.length === 0) { %>
      <div class="text-center py-5">
        <i class="fas fa-users fa-3x text-muted mb-3"></i>
        <h4>No Students Found</h4>
        <p class="text-muted">Add students to this class to start marking attendance.</p>
        <a href="/class/<%= class.id %>/student/new" class="btn btn-primary">
          <i class="fas fa-user-plus me-2"></i>Add Students
        </a>
      </div>
    <% } %>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function setStatus(studentId, status) {
      // Update hidden input
      document.getElementById(`status-${studentId}`).value = status;
      
      // Update button states
      const card = document.getElementById(`student-${studentId}`);
      const buttons = card.querySelectorAll('.status-btn');
      
      buttons.forEach(btn => {
        btn.classList.remove('active');
      });
      
      const activeButton = card.querySelector(`.status-btn.${status}`);
      if (activeButton) {
        activeButton.classList.add('active');
      }
      
      // Update card styling
      card.className = `card student-card ${status}`;
      
      // Update counters
      updateCounters();
    }

    function markAllPresent() {
      if (confirm('Mark all students as present?')) {
        const students = document.querySelectorAll('[data-student-id]');
        students.forEach(card => {
          const studentId = card.getAttribute('data-student-id');
          setStatus(studentId, 'present');
        });
      }
    }

    function clearAll() {
      if (confirm('Clear all attendance selections?')) {
        const students = document.querySelectorAll('[data-student-id]');
        students.forEach(card => {
          const studentId = card.getAttribute('data-student-id');
          document.getElementById(`status-${studentId}`).value = '';
          
          const buttons = card.querySelectorAll('.status-btn');
          buttons.forEach(btn => btn.classList.remove('active'));
          
          card.className = 'card student-card';
        });
        updateCounters();
      }
    }

    function updateCounters() {
      const statuses = ['present', 'absent', 'late', 'excused'];
      
      statuses.forEach(status => {
        const count = document.querySelectorAll(`.student-card.${status}`).length;
        document.getElementById(`${status}Count`).textContent = count;
      });
    }

    // Initialize counters on page load
    document.addEventListener('DOMContentLoaded', function() {
      updateCounters();
      
      // Set initial card states based on existing status
      <% students.forEach(student => { %>
        <% if (student.status) { %>
          const card<%= student.id %> = document.getElementById('student-<%= student.id %>');
          card<%= student.id %>.className = 'card student-card <%= student.status %>';
        <% } %>
      <% }) %>
      
      updateCounters();
    });

    // Form validation
    document.getElementById('attendanceForm').addEventListener('submit', function(e) {
      const attendanceInputs = document.querySelectorAll('input[name^="attendance"]');
      let hasAttendance = false;
      
      attendanceInputs.forEach(input => {
        if (input.value) {
          hasAttendance = true;
        }
      });
      
      if (!hasAttendance) {
        e.preventDefault();
        alert('Please mark attendance for at least one student.');
        return false;
      }
    });
  </script>
</body>
</html>